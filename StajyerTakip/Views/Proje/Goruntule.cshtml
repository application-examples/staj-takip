@model Proje
@{
    ViewData["Title"] = "Goruntule";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using Microsoft.AspNetCore.Http
@{
    var yetki = Context.Session.GetInt32("yetki");
    var profilid = Context.Session.GetInt32("profilid");
    var id = Context.Session.GetInt32("id");

}
<div class="container">
    <div class="row">
        <div class="col-5 h-100">
            <h4>Üyeler</h4><hr />
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Birim Koordinatörleri</h4>
                </div>
                <div class="comment-widgets scrollable ps-container ps-theme-default" data-ps-id="817a7410-88c7-23a4-7ebb-83b12d06d09f">
                    <!-- Comment Row -->
                    @foreach (var i in Model.BirimKoordinatorleri)
                    {
                        <div class="d-flex flex-row comment-row m-t-0">
                            <div class="p-2"><img src="@i.BirimKoordinatoru.Profil.Fotograf" alt="user" width="50" class="rounded-circle"></div>
                            <div class="comment-text w-100">
                                <h6 class="font-medium">@i.BirimKoordinatoru.Profil.Ad @i.BirimKoordinatoru.Profil.Soyad</h6>
                                <span class="m-b-0 d-block">@i.BirimKoordinatoru.Unvan</span>
                                <span class="m-b-15 d-block">@i.BirimKoordinatoru.Profil.KullaniciAdi</span>
                                <div class="comment-footer">
                                    <span class="text-muted float-right">@i.BirimKoordinatoru.Profil.Email</span>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px;"><div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div></div><div class="ps-scrollbar-y-rail" style="top: 0px; right: 3px;"><div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 0px;"></div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">Stajyerler</h4>
                </div>
                <div class="comment-widgets scrollable ps-container ps-theme-default" data-ps-id="817a7410-88c7-23a4-7ebb-83b12d06d09f">
                    <!-- Comment Row -->
                    @foreach (var i in Model.Stajyerler)
                    {
                        <div class="d-flex flex-row comment-row m-t-0">
                            <div class="p-2"><img src="@i.Stajyer.Profil.Fotograf" alt="user" width="50" class="rounded-circle"></div>
                            <div class="comment-text w-100">
                                <h6 class="font-medium">@i.Stajyer.Profil.Ad @i.Stajyer.Profil.Soyad</h6>
                                <span class="m-b-0 d-block">@i.Stajyer.Okul</span>
                                <span class="m-b-0 d-block">@i.Stajyer.Bolum</span>
                                <span class="m-b-15 d-block">@i.Stajyer.Profil.KullaniciAdi</span>
                                <div class="comment-footer">
                                    <span class="text-muted float-right">@i.Stajyer.Profil.Email</span>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px;"><div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div></div><div class="ps-scrollbar-y-rail" style="top: 0px; right: 3px;"><div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 0px;"></div></div>
                </div>
            </div>
        </div>
        <div class="col-7">
            <h4>Proje Bilgileri</h4><hr />
            <div class="card">
                <div class="card-header bg-info text-info">
                    Proje Bilgileri
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-2 offset-1">
                            <label class="h6">Proje Adı: </label>
                        </div>
                        <div class="col-5">
                            <label class="h6">@Model.Ad</label>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-sm-2 offset-1">
                            <label class="h6">Proje Açıklaması: </label>
                        </div>
                        <div class="col-5">
                            <p class="h6">@Model.Icerik</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-sm-2 offset-1">
                            <label class="h6">Başlangıç Tarihi: </label>
                        </div>
                        <div class="col-5">
                            <label class="h6">@Model.Baslangic.ToString("dd/MMMM/yyyy")</label>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-sm-2 offset-1">
                            <label class="h6">Bitiş Tarihi: </label>
                        </div>
                        <div class="col-5">
                            <label class="h6">@Model.Bitis.ToString("dd/MMMM/yyyy")</label>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-sm-2 offset-1">
                            <label class="h6">Proje Linki: </label>
                        </div>
                        <div class="col-5">
                            <label class="h6"><a class="" href="@Model.Link">@Model.Ad</a></label>
                        </div>
                    </div>
                </div>
            </div>
            <h4>Sohbet</h4><hr />
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Proje Hakkında Konuşun</h4>
                            <div class="chat-box scrollable ps-container ps-theme-default ps-active-y" style="height:475px;" data-ps-id="c3c3b199-cd45-090b-b626-8efd1ae929a8">
                                <!--chat Row -->
                                <ul class="chat-list" id="chatlist"></ul>
                                <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px;"><div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div></div><div class="ps-scrollbar-y-rail" style="top: 0px; height: 475px; right: 3px;"><div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 445px;"></div></div>
                            </div>
                        </div>
                        <div class="card-body border-top">
                            <div class="row">
                                <div class="col-9">
                                    <div class="input-field m-t-0 m-b-0">
                                        <textarea id="chat" placeholder="Yazın ve enterlayın" class="form-control border-0"></textarea>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn-circle btn-lg btn-cyan float-right text-white" href="" id="gonder"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="text" id="id1" value="@Model.ID" hidden />
<input type="text" id="profilid" value="@profilid" hidden />
<script>

    $(function () {
        var id = $('#id1').val();
        var profilid = $('#profilid').val();
        var cek = () => {
            $.ajax({
                url: '/Proje/GetAllMessages',
                data: { id: id },
                dataType: 'json',
                success: function (list) {
                    var html = "";
                    $('#chatlist').html('');
                    console.log('girdi');
                    $.each(list, function (id, data) {
                        if (data.yazanProfilID != profilid) {
                            html += '<li class="chat-item">' +
                                '<div class="chat-img" > <img src="' + data.yazanProfil.fotograf + '" alt="user"></div>' +
                                '<div class="chat-content">' +
                                '<h6 class="font-medium">' + data.yazanProfil.ad + ' ' + data.yazanProfil.soyad + '</h6>' +
                                '<div class="box bg-light-info">' + data.mesaj + '</div>' +
                                '</div>' +
                                '<div class="chat-time">10:56 am</div>' +
                                '</li >';
                        }
                        else {
                            html += ' <li class="odd chat-item">' +
                                '<div class="chat-content">' +
                                '<div class="box bg-light-inverse">' + data.mesaj + '</div>' +
                                '<br>' +
                                '</div>' +
                                '<div class="chat-time">10:59 am</div>' +
                                '</li >';
                        }
                    });
                    $('#chatlist').html(html);
                }
            });
        }
        cek();


        setInterval(cek, 1000 * 10);
        var gonder = () => {
            $.ajax({
                url: '/Proje/MessageSend',
                data: { chat: { mesaj: $('#chat').val(), yazanProfilID: profilid }, id: id },
                dataType: 'json',
                type: 'POST',
                success: function (data) {
                    $('#chat').val('');
                    cek();
                },
                error: function () {
                    alert('Mesaj gönderilirken hata oluştu.');
                }
            });
        }

        $(document).on('click', '#gonder', function () {
            gonder();
        });
    });
</script>